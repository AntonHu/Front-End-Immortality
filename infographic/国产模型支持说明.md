# 国产文生图模型支持说明

## 当前已支持的模型

- **DashScope（阿里云通义万象）** ✅ 已实现
  - 模型：`z-image-turbo`（默认）、`qwen-image`、`wan` 系列
  - 计费：按量付费
  - API Key：`DASHSCOPE_API_KEY`

## 可添加的国产模型（推荐）

### 1. 腾讯混元生图 ⭐⭐⭐⭐⭐

**推荐理由**：
- ✅ 支持**预付费资源包**（包月/包年）
- ✅ 提供免费额度
- ✅ API 文档完善
- ✅ 企业级稳定性

**模型信息**：
- 模型名称：`hunyuan-image`
- API 端点：`https://hunyuan.tencentcloudapi.com`
- 计费方式：
  - 免费额度：首次开通后获得
  - 预付费资源包：支持包月/包年
  - 后付费：按量计费

**API 接口**：
- `SubmitHunyuanImageJob` - 提交生图任务
- `QueryHunyuanImageJob` - 查询生图任务

**环境变量**：
```bash
TENCENT_SECRET_ID=your_secret_id
TENCENT_SECRET_KEY=your_secret_key
TENCENT_HUNYUAN_IMAGE_MODEL=hunyuan-image
```

**文档**：
- https://cloud.tencent.com/document/product/1729/97731
- https://cloud.tencent.com/document/product/1729/101848

---

### 2. 智谱AI CogView ⭐⭐⭐⭐

**推荐理由**：
- ✅ 支持**流量包预付费**（包月）
- ✅ 提供多种分辨率（720P、4K）
- ✅ 企业采购有优惠（15%用量返还）

**模型信息**：
- 模型名称：`cogview-3`、`cogview-4`
- API 端点：`https://open.bigmodel.cn/api/paas/v4/images/generations`
- 计费方式：
  - 标准分辨率（720P）：0.25元/次
  - 4K超清：0.75元/次
  - 流量包：500元/50万token、2000元/300万token、8000元/1500万token

**环境变量**：
```bash
ZHIPU_API_KEY=your_api_key
ZHIPU_IMAGE_MODEL=cogview-3
```

**文档**：
- https://docs.bigmodel.cn/cn/guide/tools/knowledge/price
- https://www.zhipucn.com/price.html

---

### 3. 百度文心一格 ⭐⭐⭐

**推荐理由**：
- ✅ 百度生态，中文优化好
- ⚠️ 主要按量计费（需确认是否有包月）

**模型信息**：
- 模型名称：`ernie-vilg-v2`
- API 端点：`https://aip.baidubce.com/rpc/2.0/ai_custom/v1/wenxinworkshop/image/ernie_vilg_v2`
- 计费方式：按量计费

**环境变量**：
```bash
BAIDU_API_KEY=your_api_key
BAIDU_SECRET_KEY=your_secret_key
BAIDU_IMAGE_MODEL=ernie-vilg-v2
```

**文档**：
- https://cloud.baidu.com/product/wenxinworkshop.html

---

### 4. 字节跳动豆包（需确认）⭐⭐⭐

**推荐理由**：
- ✅ 字节生态
- ⚠️ 需确认是否有文生图 API 和包月套餐

**模型信息**：
- 模型名称：待确认
- API 端点：待确认
- 计费方式：待确认

---

## 添加新 Provider 的步骤

### 1. 更新类型定义

在 `scripts/types.ts` 中添加新的 provider：

```typescript
export type Provider = "google" | "openai" | "dashscope" | "tencent" | "zhipu" | "baidu";
```

### 2. 创建 Provider 实现文件

在 `scripts/providers/` 目录下创建新文件，例如 `tencent.ts`：

```typescript
import type { CliArgs } from "../types";

export function getDefaultModel(): string {
  return process.env.TENCENT_HUNYUAN_IMAGE_MODEL || "hunyuan-image";
}

function getApiKey(): { secretId: string; secretKey: string } | null {
  const secretId = process.env.TENCENT_SECRET_ID;
  const secretKey = process.env.TENCENT_SECRET_KEY;
  if (!secretId || !secretKey) return null;
  return { secretId, secretKey };
}

export async function generateImage(
  prompt: string,
  model: string,
  args: CliArgs
): Promise<Uint8Array> {
  const credentials = getApiKey();
  if (!credentials) throw new Error("TENCENT_SECRET_ID and TENCENT_SECRET_KEY are required");

  // 实现腾讯混元生图 API 调用
  // 参考：https://cloud.tencent.com/document/product/1729/101848
}
```

### 3. 更新主程序

在 `scripts/main.ts` 中：

1. 更新 `parseArgs` 函数中的 provider 验证
2. 更新 `detectProvider` 函数
3. 更新 `loadProviderModule` 函数
4. 更新 `printUsage` 函数中的帮助信息
5. 更新错误提示中的 API key 说明

### 4. 更新 ExtendConfig 类型

在 `scripts/types.ts` 中更新 `ExtendConfig`：

```typescript
export type ExtendConfig = {
  // ...
  default_model: {
    google: string | null;
    openai: string | null;
    dashscope: string | null;
    tencent: string | null;  // 新增
    zhipu: string | null;    // 新增
    baidu: string | null;    // 新增
  };
};
```

---

## 推荐优先级

1. **腾讯混元生图** ⭐⭐⭐⭐⭐
   - 有明确的预付费资源包（包月）
   - API 文档完善
   - 企业级稳定性

2. **智谱AI CogView** ⭐⭐⭐⭐
   - 有流量包预付费机制
   - 价格相对透明
   - 企业采购有优惠

3. **百度文心一格** ⭐⭐⭐
   - 中文优化好
   - 但需确认是否有包月套餐

---

## 注意事项

1. **API 认证方式**：
   - 腾讯混元：使用 SecretId + SecretKey（需要签名）
   - 智谱AI：使用 API Key
   - 百度：使用 API Key + Secret Key

2. **异步任务处理**：
   - 腾讯混元使用任务提交+查询模式，需要轮询
   - 其他模型通常是同步返回

3. **图片格式**：
   - 确认各模型返回的图片格式（base64、URL、二进制）
   - 统一转换为 `Uint8Array` 返回

4. **错误处理**：
   - 实现统一的错误处理
   - 支持重试机制（如 `isRetryableGenerationError`）

---

## 参考实现

可以参考现有的 `dashscope.ts` 实现，它展示了：
- API key 获取
- 请求构建
- 响应解析
- 图片下载/解码
- 错误处理
